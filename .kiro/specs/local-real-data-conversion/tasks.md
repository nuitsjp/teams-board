# Implementation Plan

## Requirements Coverage

| 要件ID | タスク |
|--------|--------|
| 1.1, 1.3 | 1.1 |
| 1.2 | 1.2 |
| 1.4 | 4.1 |
| 2.1, 2.3, 2.4 | 3.1 |
| 2.2, 3.1, 3.2 | 2.2 |
| 3.3, 3.4 | 2.3 |
| 4.1, 4.2, 4.3, 4.4 | 5.1 |
| 5.1, 5.2, 5.3 | 3.2 |
| 5.4 | 4.1 |

## Tasks

- [x] 1. 入力読み込みとCSV変換の実装
- [x] 1.1 サンプルデータセット読み込み機能を実装する
  - `data/sample` ディレクトリ配下のCSVファイルを列挙して取り込む仕組みを構築する
  - 対象CSVが0件の場合は即座にエラーを返して処理を中断する
  - 読み取り不可ファイルや不正拡張子を検出し、不足ファイル情報をエラー結果に含める
  - ファイル名・サイズ等のメタ情報を後続処理に渡せる形式で返却する
  - _Requirements: 1.1, 1.3_

- [x] 1.2 (P) ローカルファイル入力を既存CSV変換器へ適合させるアダプターを実装する
  - Node.jsのファイル読み込み結果をブラウザ向けの既存変換器が期待する入力形式に変換する
  - UTF-16LEエンコーディングのCSVを正しくデコードできるようにする
  - 既存の `CsvTransformer.parse` をそのまま呼び出し、変換結果と警告を取得する
  - 変換エラーや警告を上位呼び出し元に透過的に伝播する
  - _Requirements: 1.2_

- [x] 2. 集約と検証の実装
- [x] 2.1 複数CSV変換結果をセッション集約する機能を実装する
  - CSV単位の変換結果からセッションレコード群を保持する
  - 既存のインデックスマージ機能を利用してダッシュボードインデックスを逐次構築する
  - セッションID重複を検出した場合は警告として記録し、上書きを防止する
  - 集約結果としてインデックス、セッション一覧、警告一覧を返却する
  - _Requirements: 2.2, 3.3_

- [x] 2.2 (P) 出力JSONの契約検証機能を実装する
  - インデックスJSONの必須キーと型を検証し、欠落や型不正を検出する
  - セッションJSONの必須キーと型を検証し、ファイル単位で結果を返す
  - 検証失敗時はデータを不採用とし、公開領域への置換を禁止する判定を返す
  - エラーの重大度（エラー/警告）をファイルパス・フィールドパス付きで報告する
  - _Requirements: 2.2, 3.1, 3.2_

- [x] 2.3 (P) 集計値と明細値の整合性検証機能を実装する
  - インデックスのセッションID参照が実在するセッションレコードに対応するか検証する
  - メンバーのセッションIDと各セッションの出席記録が整合するか検証する
  - 合計時間と明細合計の差分を検証し、不一致を検出する
  - 不整合箇所をファイル単位・項目種別で特定し、検証結果に含める
  - _Requirements: 3.3, 3.4_

- [x] 3. 公開データ置換とレポーティングの実装
- [x] 3.1 ステージング経由で公開データを安全に置換する機能を実装する
  - 変換結果をステージングディレクトリに書き出す
  - ステージング検証が成功した場合のみ、公開ディレクトリへ切り替える
  - 置換処理が失敗した場合は公開ディレクトリを変更せずに保持する
  - ファイルごとの書き込み・移動結果（成功/失敗）を追跡し返却する
  - 同時実行を防止するロックの仕組みを設ける
  - _Requirements: 2.1, 2.3, 2.4, 5.3_

- [x] 3.2 (P) 変換実行結果のレポーティング機能を実装する
  - 総合ステータス（成功/部分成功/失敗）を計算して表示する
  - 入力CSVファイル数、生成セッション数、書き込みファイル数、失敗ファイル数を出力する
  - 部分失敗時は成功分と失敗分を分離して報告する
  - 失敗ファイルごとの理由を明示し、エラー箇所をファイル単位で提示する
  - 標準出力への表示と、任意でJSONファイルへの保存を行う
  - _Requirements: 2.4, 3.4, 5.1, 5.2, 5.3_

- [x] 4. ローカル変換コマンドの統合実装
- [x] 4.1 入力から検証・置換・レポートまでを統制するコマンドを実装する
  - 実行順序を固定する: 入力読込 → 変換 → 検証 → 置換 → 確認 → レポート
  - 検証失敗時は置換を呼び出さず、エラーレポートを出力して終了する
  - 同一入力に対して何度でも再実行可能にし、べき等な動作を保証する
  - ローカル環境のみで変換処理を完結させ、外部サービスに依存しない
  - コマンドラインからオプション（入力ディレクトリ、出力ディレクトリ、UI検証有無等）を受け付ける
  - _Requirements: 1.4, 5.4_

- [x] 5. ローカル画面動作確認の実装
- [x] 5.1 置換後データでの画面動作を検証する機能を実装する
  - 置換後のインデックスJSONを読み込み、一覧表示が成立するか確認する
  - 任意メンバー1件以上でセッションJSONを読み込み、ドリルダウン表示が成立するか確認する
  - 参照先JSONが欠落または不正な場合に、期待するエラーメッセージが表示されるか確認する
  - 一覧から詳細、詳細から戻るという最小画面遷移が成立するか確認する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 6. 結合テストとエンドツーエンド検証
- [x] 6.1 変換パイプライン全体の結合テストを実装する
  - 複数CSVを連続変換し、ダッシュボードインデックスが累積更新されることを確認する
  - 検証失敗時に公開データが未変更であることを確認する
  - 部分失敗時にレポートが成功分と失敗分を分離して出力されることを確認する
  - 同一入力の再実行で結果が再現されることを確認する
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.3, 3.1, 3.2, 5.4_

- [x]* 6.2 (P) 置換後データでのUI表示テストを実装する
  - 置換後データで一覧表示が成立することを確認するテストを作成する
  - ドリルダウン表示が成立することを確認するテストを作成する
  - 参照先JSON欠落時のエラー表示を確認するテストを作成する
  - 一覧→詳細→戻るの画面遷移を確認するテストを作成する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_
