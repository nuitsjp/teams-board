# 実装計画

- [x] 1. FileQueueManagerの実装
- [x] 1.1 ファイルキューの基本管理機能を実装する
  - ファイルの追加・削除・状態取得のコアロジックを構築する
  - 各ファイルに一意IDを付与し、状態（pending → validating → parsed → ready等）を管理する
  - キュー変更時にコールバックで通知する仕組みを組み込む
  - コンストラクタでCsvTransformerインスタンスとコールバック関数を受け取る
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 1.2 ファイルバリデーション機能を実装する
  - ファイル拡張子チェック（.csvのみ許可）を追加する
  - ファイルサイズ上限チェック（10MB）を追加する
  - バリデーション失敗時はerror状態に遷移させ、エラーメッセージを保持する
  - バリデーション成功ファイルのみCSVパースに進む
  - _Requirements: 3.1, 3.3_

- [x] 1.3 CSVパース実行と結果管理を実装する
  - バリデーション通過後、CsvTransformerを呼び出してファイルを解析する
  - パース成功時はparsed状態に遷移させ、セッション情報を保持する
  - パース失敗時はerror状態に遷移させ、エラー詳細を保持する
  - 複数ファイルを逐次処理し、1ファイルの失敗が他ファイルに影響しないようにする
  - _Requirements: 1.1, 3.2_

- [x] 1.4 重複セッションID検出機能を実装する
  - 既存セッションIDの一覧を受け取り、保持する機能を追加する
  - パース結果のセッションIDを既存一覧と照合し、重複を検出する
  - 重複検出時はduplicate_warning状態に遷移させる
  - 管理者が上書きを承認した場合にready状態に遷移させる機能を追加する
  - _Requirements: 2.3_

- [x] 1.5 FileQueueManagerの単体テストを作成する
  - ファイル追加・削除・状態取得の基本動作を検証する
  - バリデーション（拡張子、サイズ境界値）の正常・異常ケースを検証する
  - CSVパース成功・失敗時の状態遷移を検証する
  - 重複検出と承認フローの動作を検証する
  - 複数ファイル混在時（正常+異常）の独立処理を検証する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.3, 3.1, 3.2, 3.3_

- [x] 2. AdminPanelのリファクタリングと複数ファイル対応
- [x] 2.1 AdminPanelの初期化とFileQueueManager統合を実装する
  - コンストラクタにDataFetcherパラメータを追加する
  - 初期化時にDataFetcherから既存インデックスを取得し、セッションID一覧をFileQueueManagerに設定する
  - FileQueueManagerをインスタンス化し、キュー更新コールバックでUI再描画を接続する
  - 単一ファイル用の旧状態フィールドをFileQueueManager委譲に置き換える
  - _Requirements: 1.1, 2.3_

- [x] 2.2 (P) ドロップゾーンUIの改善を実装する
  - ドロップゾーンにファイルアイコンとアップロード手順の説明テキストを常時表示する
  - ファイル選択inputにmultiple属性を追加し、複数ファイル選択を有効にする
  - ブラウザウィンドウへのドラッグ時にドロップゾーンをハイライトし、ガイドテキスト「ここにドロップ」を表示する
  - ドロップ時のフェードインアニメーションを追加する
  - キューにファイルがある場合、ドロップゾーンを縮小表示し「さらにファイルを追加」テキストに切り替える
  - _Requirements: 1.1, 1.2, 5.1, 5.2, 5.3, 5.4_

- [x] 2.3 (P) CSSスタイルの追加を実装する
  - ドロップゾーンのアニメーション用keyframes（フェードイン、縮小トランジション）を定義する
  - エラーメッセージ用の赤色警告スタイルを追加する
  - 成功メッセージ用の緑色確認スタイルを追加する
  - プログレスバーのスタイルを定義する
  - サマリーカードとキュー一覧のスタイルを定義する
  - ドロップゾーン縮小状態のスタイルを定義する
  - _Requirements: 3.4, 5.1, 5.2, 5.4_

- [x] 3. プレビュー表示の実装
- [x] 3.1 ファイルキュー一覧の描画を実装する
  - キュー更新コールバックに応じて、ファイル一覧（名前・サイズ・状態アイコン）を描画する
  - 各ファイルに削除ボタンを表示し、クリック時にFileQueueManagerのremoveFileを呼び出す
  - ファイルの状態（未処理/処理中/成功/失敗）に応じたアイコンとスタイルを適用する
  - _Requirements: 1.3, 1.4_

- [x] 3.2 サマリーカードとプレビュー詳細の描画を実装する
  - 各ファイルのパース結果から、勉強会名・開催日・参加者数・合計学習時間のサマリーカードを生成する
  - サマリーカードのクリックで参加者一覧の詳細テーブルを展開/折りたたみ表示する
  - 複数ファイルがキューにある場合、各ファイルごとに独立したプレビューセクションを描画する
  - _Requirements: 2.1, 2.2, 2.4_

- [x] 3.3 重複セッション警告UIを実装する
  - 重複が検出されたファイルに警告アイコンとハイライトスタイルを適用する
  - 上書き確認ボタンを表示し、クリック時にFileQueueManagerのapproveDuplicateを呼び出す
  - 管理者が削除を選択した場合の導線も提供する
  - _Requirements: 2.3_

- [x] 4. 保存処理と進捗表示の実装
- [x] 4.1 一括保存フローを実装する
  - 「一括保存」ボタンを追加し、ready状態のファイルを対象に逐次保存処理を実行する
  - 各ファイルについてBlobWriterのexecuteWriteSequenceを呼び出し、結果に応じてFileQueueManagerの状態を更新する
  - 保存処理中はボタンを無効化し、処理中のファイル名と「保存中...」ステータスを表示する
  - _Requirements: 4.1, 4.2_

- [x] 4.2 プログレスバーの描画を実装する
  - HTML progress要素を使用し、全体の保存進捗（完了数/全体数）を表示する
  - 個別ファイルの保存完了時にステータスを成功（✓）または失敗（✗）に更新する
  - _Requirements: 4.1, 4.3_

- [x] 4.3 保存失敗時のリトライ機能を実装する
  - 一部ファイルの保存が失敗した場合、失敗ファイルのみを対象としたリトライボタンを表示する
  - リトライボタンのクリックで失敗ファイルの保存を再実行する
  - リトライ結果に応じてステータスを再更新する
  - _Requirements: 4.4_

- [x] 5. エントリーポイント更新と統合テスト
- [x] 5.1 main.jsのエントリーポイントを更新する
  - AdminPanelのコンストラクタ呼び出しにDataFetcherを追加する
  - 既存の初期化フローとの整合性を確認する
  - _Requirements: 1.1, 1.2_

- [x] 5.2 統合テストを作成する
  - 複数ファイルアップロード→プレビュー→保存の一連のフローを検証する
  - 正常ファイルと不正ファイルが混在した場合の独立処理を検証する
  - 保存失敗→リトライの一連のフローを検証する
  - 重複セッション検出→承認→保存のフローを検証する
  - _Requirements: 1.1, 1.2, 2.1, 2.3, 3.1, 3.2, 3.3, 4.1, 4.4_
