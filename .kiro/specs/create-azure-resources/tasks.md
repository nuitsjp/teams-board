# Implementation Plan

- [x] 1. インフラプロビジョニングスクリプトの作成
- [x] 1.1 スクリプトの骨格とパラメータ定義を作成する
  - PowerShellスクリプトファイルを作成し、スクリプト先頭にパラメータの説明コメントを記載する
  - `param()`ブロックでサブスクリプションID、リソースグループ名、Storageアカウント名、リージョン、ポリシー名、ポリシー有効期限日数を定義し、それぞれにデフォルト値を設定する
  - `$ErrorActionPreference = 'Stop'`を設定し、エラー発生時にスクリプトが即座に中断するようにする
  - サブスクリプションの切替処理を実装し、対象サブスクリプションに切り替えてから後続処理を実行する
  - _Requirements: 1.1, 1.2, 1.7, 1.8, 8.1, 8.2, 8.3, 8.4_

- [x] 1.2 リソースグループの存在確認と作成/利用の分岐を実装する
  - リソースグループの存在をチェックし、存在する場合は既存のものをそのまま利用する
  - 存在しない場合はパラメータで指定されたリージョンに新規作成する
  - 存在確認時はエラーを抑制して`$null`チェックで分岐する
  - 作成/利用のどちらを行ったかをコンソールに出力する
  - _Requirements: 1.3, 1.4, 1.7_

- [x] 1.3 Storageアカウントの作成と設定強制上書きを実装する
  - Storageアカウントの存在をチェックし、存在しない場合はStorageV2種類、Standard_LRS冗長性、Hotアクセス層で新規作成する
  - 存在する場合は設定を強制上書きし、StorageV2/Standard_LRS/Hot/TLS1.2/HTTPSのみの構成を適用する
  - 最小TLSバージョンをTLS1.2に設定する
  - HTTPSトラフィックのみを許可する
  - 新規作成/設定上書きのどちらを行ったかをコンソールに出力する
  - _Requirements: 1.5, 1.6, 1.7, 2.1, 2.2, 2.3, 2.4_

- [x] 1.4 静的サイトホスティングの有効化を実装する
  - Storageアカウントのコンテキストを取得し、静的サイトホスティングを有効化する
  - インデックスドキュメントを`index.html`に設定する
  - エラードキュメントも`index.html`に設定し、SPAフォールバックに対応する
  - 静的サイトエンドポイントURLとBlobサービスエンドポイントURLをコンソールに出力する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 1.5 CORS設定を実装する
  - 静的サイトエンドポイントURLからオリジンを動的に取得する（末尾スラッシュを除去）
  - BlobサービスのCORSルールを定義し、許可オリジン・許可メソッド（GET, PUT, HEAD）・許可ヘッダー（x-ms-blob-type, x-ms-blob-content-type, content-type, x-ms-version）・公開ヘッダー（x-ms-meta-*）を設定する
  - CORS設定を常に上書き適用する（既存設定があっても正しい値に強制する）
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 1.6 Stored Access Policyの作成/更新を実装する
  - `$web`コンテナに対するStored Access Policyの存在を確認する（コンテナ名はシングルクォートで指定）
  - 存在しない場合は新規作成し、権限を`rcwl`（Read, Create, Write, List）に設定する
  - 存在する場合は既存ポリシーを最新の設定で上書きする
  - ポリシーの有効期限はパラメータで指定された日数（デフォルト30日）を現在時刻に加算して設定する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 2. (P) SASトークン生成スクリプトの作成
  - PowerShellスクリプトファイルを作成し、スクリプト先頭にパラメータの説明コメントを記載する
  - `param()`ブロックでサブスクリプションID、リソースグループ名、Storageアカウント名、ポリシー名を定義し、デフォルト値を設定する
  - サブスクリプション切替とStorageアカウントのコンテキスト取得を実装する
  - Stored Access Policyに紐づくContainer SASトークンを生成する（`-Permission`は指定せずPolicyから継承）
  - 静的サイトエンドポイントURLを取得し、SASトークンと組み合わせて管理者用完全URL（`https://<endpoint>/index.html?token=<SAS>`）を組み立てて出力する
  - SASトークンの先頭に`?`が含まれる場合のURL結合を考慮する
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 8.1, 8.2, 8.3, 8.4_

- [x] 3. (P) 静的ファイルデプロイスクリプトの作成
  - PowerShellスクリプトファイルを作成し、スクリプト先頭にパラメータの説明コメントを記載する
  - `param()`ブロックでサブスクリプションID、リソースグループ名、Storageアカウント名、ソースパスを定義し、デフォルト値を設定する
  - MIMEマッピングテーブルを定義し、拡張子ごとに適切なContent-Typeを対応付ける（html, css, js, json, png, svg, ico等）
  - ソースディレクトリ配下のファイルを再帰的に列挙し、ディレクトリ構造を維持したBlob名を生成する（パス区切りを`/`に変換）
  - 各ファイルをMIMEマッピングに基づくContent-Typeを明示指定して`$web`コンテナにアップロードする（既存Blobは上書き許可）
  - アップロード完了後にアップロードされたファイル数と静的サイトURLをコンソールに出力する
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 8.1, 8.2, 8.3, 8.4_

- [x] 4. Azure環境での動作検証
- [x] 4.1 プロビジョニングスクリプトの初回実行と冪等性検証
  - プロビジョニングスクリプトを初回実行し、全リソース（RG、SA、静的サイト、CORS、Policy）が新規作成されることを確認する
  - スクリプトを2回目実行し、既存リソースが利用/上書きされエラーなく完了することを確認する
  - 各ステップの実行状況（作成/更新の区別）がコンソールに出力されることを確認する
  - 静的サイトエンドポイントURLとBlobサービスエンドポイントURLが出力されることを確認する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4_

- [x] 4.2 SASトークン生成と静的ファイルデプロイの検証
  - SASトークン生成スクリプトを実行し、管理者用完全URLが出力されることを確認する
  - 静的ファイルデプロイスクリプトを実行し、全ファイルが正しいContent-Typeでアップロードされることを確認する
  - 静的サイトエンドポイントにブラウザでアクセスし、ダッシュボードが正しく表示されることを確認する
  - 生成されたSASトークンで管理者操作（Blobへの書き込み）が可能であることを確認する
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4, 7.5_
